:PROPERTIES:
:ID:       09d95811-143e-4544-affb-4daff24ee32e
:END:
#+title: Javaå†…å­˜åŒºåŸŸ

* Java å†…å­˜åŒºåŸŸè¯¦è§£
#+begin_src quote
è‹¥æ— ç‰¹æ®Šè¯´æ˜ï¼Œé’ˆå¯¹çš„éƒ½æ˜¯HotSpotè™šæ‹Ÿæœº
#+end_src
** é¢è¯•å¸¸è§é—®é¢˜
*** åŸºæœ¬é—®é¢˜
- **ä»‹ç»ä¸‹ Java å†…å­˜åŒºåŸŸï¼ˆè¿è¡Œæ—¶æ•°æ®åŒºï¼‰**
- **Java å¯¹è±¡çš„åˆ›å»ºè¿‡ç¨‹ï¼ˆäº”æ­¥ï¼Œå»ºè®®èƒ½é»˜å†™å‡ºæ¥å¹¶ä¸”è¦çŸ¥é“æ¯ä¸€æ­¥è™šæ‹Ÿæœºåšäº†ä»€ä¹ˆï¼‰**
- **å¯¹è±¡çš„è®¿é—®å®šä½çš„ä¸¤ç§æ–¹å¼ï¼ˆå¥æŸ„å’Œç›´æ¥æŒ‡é’ˆä¸¤ç§æ–¹å¼ï¼‰**

*** æ‹“å±•é—®é¢˜

- **String ç±»å’Œå¸¸é‡æ± **
- **8 ç§åŸºæœ¬ç±»å‹çš„åŒ…è£…ç±»å’Œå¸¸é‡æ± **

** æ¦‚è¿°

å¯¹äº Java ç¨‹åºå‘˜æ¥è¯´ï¼Œåœ¨è™šæ‹Ÿæœºè‡ªåŠ¨å†…å­˜ç®¡ç†æœºåˆ¶ä¸‹ï¼Œä¸å†éœ€è¦åƒ C/C++ç¨‹åºå¼€å‘ç¨‹åºå‘˜è¿™æ ·ä¸ºæ¯ä¸€ä¸ª new æ“ä½œå»å†™å¯¹åº”çš„ delete/free æ“ä½œï¼Œä¸å®¹æ˜“å‡ºç°å†…å­˜æ³„æ¼å’Œå†…å­˜æº¢å‡ºé—®é¢˜ã€‚æ­£æ˜¯å› ä¸º Java ç¨‹åºå‘˜æŠŠå†…å­˜æ§åˆ¶æƒåˆ©äº¤ç»™ Java è™šæ‹Ÿæœºï¼Œä¸€æ—¦å‡ºç°å†…å­˜æ³„æ¼å’Œæº¢å‡ºæ–¹é¢çš„é—®é¢˜ï¼Œå¦‚æœä¸äº†è§£è™šæ‹Ÿæœºæ˜¯æ€æ ·ä½¿ç”¨å†…å­˜çš„ï¼Œé‚£ä¹ˆæ’æŸ¥é”™è¯¯å°†ä¼šæ˜¯ä¸€ä¸ªéå¸¸è‰°å·¨çš„ä»»åŠ¡ã€‚

** è¿è¡Œæ—¶æ•°æ®åŒºåŸŸ

Java è™šæ‹Ÿæœºåœ¨æ‰§è¡Œ Java ç¨‹åºçš„è¿‡ç¨‹ä¸­ä¼šæŠŠå®ƒç®¡ç†çš„å†…å­˜åˆ’åˆ†æˆè‹¥å¹²ä¸ªä¸åŒçš„æ•°æ®åŒºåŸŸã€‚JDK. 1.8 å’Œä¹‹å‰çš„ç‰ˆæœ¬ç•¥æœ‰ä¸åŒï¼Œä¸‹é¢ä¼šä»‹ç»åˆ°ã€‚

**JDK 1.8 ä¹‹å‰ï¼š**

[[./imgs/pictures/javaå†…å­˜åŒºåŸŸ/JVMè¿è¡Œæ—¶æ•°æ®åŒºåŸŸ.png]]

**JDK 1.8 ï¼š*

[[./imgs/pictures/javaå†…å­˜åŒºåŸŸ/Javaè¿è¡Œæ—¶æ•°æ®åŒºåŸŸJDK1.8.png]]

**çº¿ç¨‹ç§æœ‰çš„ï¼š**

- ç¨‹åºè®¡æ•°å™¨
- è™šæ‹Ÿæœºæ ˆ
- æœ¬åœ°æ–¹æ³•æ ˆ

**çº¿ç¨‹å…±äº«çš„ï¼š**

- å †
- æ–¹æ³•åŒº
- ç›´æ¥å†…å­˜ (éè¿è¡Œæ—¶æ•°æ®åŒºçš„ä¸€éƒ¨åˆ†)

** ç¨‹åºè®¡æ•°å™¨

ç¨‹åºè®¡æ•°å™¨æ˜¯ä¸€å—è¾ƒå°çš„å†…å­˜ç©ºé—´ï¼Œå¯ä»¥çœ‹ä½œæ˜¯å½“å‰çº¿ç¨‹æ‰€æ‰§è¡Œçš„å­—èŠ‚ç çš„è¡Œå·æŒ‡ç¤ºå™¨ã€‚**å­—èŠ‚ç è§£é‡Šå™¨å·¥ä½œæ—¶é€šè¿‡æ”¹å˜è¿™ä¸ªè®¡æ•°å™¨çš„å€¼æ¥é€‰å–ä¸‹ä¸€æ¡éœ€è¦æ‰§è¡Œçš„å­—èŠ‚ç æŒ‡ä»¤ï¼Œåˆ†æ”¯ã€å¾ªç¯ã€è·³è½¬ã€å¼‚å¸¸å¤„ç†ã€çº¿ç¨‹æ¢å¤ç­‰åŠŸèƒ½éƒ½éœ€è¦ä¾èµ–è¿™ä¸ªè®¡æ•°å™¨æ¥å®Œæˆã€‚**

å¦å¤–ï¼Œ**ä¸ºäº†çº¿ç¨‹åˆ‡æ¢åèƒ½æ¢å¤åˆ°æ­£ç¡®çš„æ‰§è¡Œä½ç½®ï¼Œæ¯æ¡çº¿ç¨‹éƒ½éœ€è¦æœ‰ä¸€ä¸ªç‹¬ç«‹çš„ç¨‹åºè®¡æ•°å™¨ï¼Œå„çº¿ç¨‹ä¹‹é—´è®¡æ•°å™¨äº’ä¸å½±å“ï¼Œç‹¬ç«‹å­˜å‚¨ï¼Œæˆ‘ä»¬ç§°è¿™ç±»å†…å­˜åŒºåŸŸä¸ºâ€œçº¿ç¨‹ç§æœ‰â€çš„å†…å­˜ã€‚**

**ä»ä¸Šé¢çš„ä»‹ç»ä¸­æˆ‘ä»¬çŸ¥é“ç¨‹åºè®¡æ•°å™¨ä¸»è¦æœ‰ä¸¤ä¸ªä½œç”¨ï¼š**

1. å­—èŠ‚ç è§£é‡Šå™¨é€šè¿‡æ”¹å˜ç¨‹åºè®¡æ•°å™¨æ¥ä¾æ¬¡è¯»å–æŒ‡ä»¤ï¼Œä»è€Œå®ç°ä»£ç çš„æµç¨‹æ§åˆ¶ï¼Œå¦‚ï¼šé¡ºåºæ‰§è¡Œã€é€‰æ‹©ã€å¾ªç¯ã€å¼‚å¸¸å¤„ç†ã€‚
2. åœ¨å¤šçº¿ç¨‹çš„æƒ…å†µä¸‹ï¼Œç¨‹åºè®¡æ•°å™¨ç”¨äºè®°å½•å½“å‰çº¿ç¨‹æ‰§è¡Œçš„ä½ç½®ï¼Œä»è€Œå½“çº¿ç¨‹è¢«åˆ‡æ¢å›æ¥çš„æ—¶å€™èƒ½å¤ŸçŸ¥é“è¯¥çº¿ç¨‹ä¸Šæ¬¡è¿è¡Œåˆ°å“ªå„¿äº†ã€‚

**æ³¨æ„ï¼šç¨‹åºè®¡æ•°å™¨æ˜¯å”¯ä¸€ä¸€ä¸ªä¸ä¼šå‡ºç° `OutOfMemoryError` çš„å†…å­˜åŒºåŸŸï¼Œå®ƒçš„ç”Ÿå‘½å‘¨æœŸéšç€çº¿ç¨‹çš„åˆ›å»ºè€Œåˆ›å»ºï¼Œéšç€çº¿ç¨‹çš„ç»“æŸè€Œæ­»äº¡ã€‚**

** Java è™šæ‹Ÿæœºæ ˆ

**ä¸ç¨‹åºè®¡æ•°å™¨ä¸€æ ·ï¼ŒJava è™šæ‹Ÿæœºæ ˆä¹Ÿæ˜¯çº¿ç¨‹ç§æœ‰çš„ï¼Œå®ƒçš„ç”Ÿå‘½å‘¨æœŸå’Œçº¿ç¨‹ç›¸åŒï¼Œæè¿°çš„æ˜¯ Java æ–¹æ³•æ‰§è¡Œçš„å†…å­˜æ¨¡å‹ï¼Œæ¯æ¬¡æ–¹æ³•è°ƒç”¨çš„æ•°æ®éƒ½æ˜¯é€šè¿‡æ ˆä¼ é€’çš„ã€‚**

**Java å†…å­˜å¯ä»¥ç²—ç³™çš„åŒºåˆ†ä¸ºå †å†…å­˜ï¼ˆHeapï¼‰å’Œæ ˆå†…å­˜ (Stack),å…¶ä¸­æ ˆå°±æ˜¯ç°åœ¨è¯´çš„è™šæ‹Ÿæœºæ ˆï¼Œæˆ–è€…è¯´æ˜¯è™šæ‹Ÿæœºæ ˆä¸­å±€éƒ¨å˜é‡è¡¨éƒ¨åˆ†ã€‚** ï¼ˆå®é™…ä¸Šï¼ŒJava è™šæ‹Ÿæœºæ ˆæ˜¯ç”±ä¸€ä¸ªä¸ªæ ˆå¸§ç»„æˆï¼Œè€Œæ¯ä¸ªæ ˆå¸§ä¸­éƒ½æ‹¥æœ‰ï¼šå±€éƒ¨å˜é‡è¡¨ã€æ“ä½œæ•°æ ˆã€åŠ¨æ€é“¾æ¥ã€æ–¹æ³•å‡ºå£ä¿¡æ¯ã€‚ï¼‰

**å±€éƒ¨å˜é‡è¡¨ä¸»è¦å­˜æ”¾äº†ç¼–è¯‘æœŸå¯çŸ¥çš„å„ç§æ•°æ®ç±»å‹**ï¼ˆbooleanã€byteã€charã€shortã€intã€floatã€longã€doubleï¼‰ã€**å¯¹è±¡å¼•ç”¨**ï¼ˆreference ç±»å‹ï¼Œå®ƒä¸åŒäºå¯¹è±¡æœ¬èº«ï¼Œå¯èƒ½æ˜¯ä¸€ä¸ªæŒ‡å‘å¯¹è±¡èµ·å§‹åœ°å€çš„å¼•ç”¨æŒ‡é’ˆï¼Œä¹Ÿå¯èƒ½æ˜¯æŒ‡å‘ä¸€ä¸ªä»£è¡¨å¯¹è±¡çš„å¥æŸ„æˆ–å…¶ä»–ä¸æ­¤å¯¹è±¡ç›¸å…³çš„ä½ç½®ï¼‰ã€‚

**Java è™šæ‹Ÿæœºæ ˆä¼šå‡ºç°ä¸¤ç§é”™è¯¯ï¼š`StackOverFlowError` å’Œ `OutOfMemoryError`ã€‚**

- **`StackOverFlowError`ï¼š** è‹¥ Java è™šæ‹Ÿæœºæ ˆçš„å†…å­˜å¤§å°ä¸å…è®¸åŠ¨æ€æ‰©å±•ï¼Œé‚£ä¹ˆå½“çº¿ç¨‹è¯·æ±‚æ ˆçš„æ·±åº¦è¶…è¿‡å½“å‰ Java è™šæ‹Ÿæœºæ ˆçš„æœ€å¤§æ·±åº¦çš„æ—¶å€™ï¼Œå°±æŠ›å‡º StackOverFlowError é”™è¯¯ã€‚
- **`OutOfMemoryError`ï¼š** Java è™šæ‹Ÿæœºæ ˆçš„å†…å­˜å¤§å°å¯ä»¥åŠ¨æ€æ‰©å±•ï¼Œ å¦‚æœè™šæ‹Ÿæœºåœ¨åŠ¨æ€æ‰©å±•æ ˆæ—¶æ— æ³•ç”³è¯·åˆ°è¶³å¤Ÿçš„å†…å­˜ç©ºé—´ï¼Œåˆ™æŠ›å‡º`OutOfMemoryError`å¼‚å¸¸ã€‚

[[./imgs/pictures/javaå†…å­˜åŒºåŸŸ/ã€Šæ·±å…¥ç†è§£è™šæ‹Ÿæœºã€‹ç¬¬ä¸‰ç‰ˆçš„ç¬¬2ç« -è™šæ‹Ÿæœºæ ˆ.png]]

Java è™šæ‹Ÿæœºæ ˆä¹Ÿæ˜¯çº¿ç¨‹ç§æœ‰çš„ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰å„è‡ªçš„ Java è™šæ‹Ÿæœºæ ˆï¼Œè€Œä¸”éšç€çº¿ç¨‹çš„åˆ›å»ºè€Œåˆ›å»ºï¼Œéšç€çº¿ç¨‹çš„æ­»äº¡è€Œæ­»äº¡ã€‚

**æ‰©å±•ï¼šé‚£ä¹ˆæ–¹æ³•/å‡½æ•°å¦‚ä½•è°ƒç”¨ï¼Ÿ**

Java æ ˆå¯ç”¨ç±»æ¯”æ•°æ®ç»“æ„ä¸­æ ˆï¼ŒJava æ ˆä¸­ä¿å­˜çš„ä¸»è¦å†…å®¹æ˜¯æ ˆå¸§ï¼Œæ¯ä¸€æ¬¡å‡½æ•°è°ƒç”¨éƒ½ä¼šæœ‰ä¸€ä¸ªå¯¹åº”çš„æ ˆå¸§è¢«å‹å…¥ Java æ ˆï¼Œæ¯ä¸€ä¸ªå‡½æ•°è°ƒç”¨ç»“æŸåï¼Œéƒ½ä¼šæœ‰ä¸€ä¸ªæ ˆå¸§è¢«å¼¹å‡ºã€‚

Java æ–¹æ³•æœ‰ä¸¤ç§è¿”å›æ–¹å¼ï¼š

1. return è¯­å¥ã€‚
2. æŠ›å‡ºå¼‚å¸¸ã€‚

ä¸ç®¡å“ªç§è¿”å›æ–¹å¼éƒ½ä¼šå¯¼è‡´æ ˆå¸§è¢«å¼¹å‡ºã€‚

** æœ¬åœ°æ–¹æ³•æ ˆ

å’Œè™šæ‹Ÿæœºæ ˆæ‰€å‘æŒ¥çš„ä½œç”¨éå¸¸ç›¸ä¼¼ï¼ŒåŒºåˆ«æ˜¯ï¼š **è™šæ‹Ÿæœºæ ˆä¸ºè™šæ‹Ÿæœºæ‰§è¡Œ Java æ–¹æ³• ï¼ˆä¹Ÿå°±æ˜¯å­—èŠ‚ç ï¼‰æœåŠ¡ï¼Œè€Œæœ¬åœ°æ–¹æ³•æ ˆåˆ™ä¸ºè™šæ‹Ÿæœºä½¿ç”¨åˆ°çš„ Native æ–¹æ³•æœåŠ¡ã€‚** åœ¨ HotSpot è™šæ‹Ÿæœºä¸­å’Œ Java è™šæ‹Ÿæœºæ ˆåˆäºŒä¸ºä¸€ã€‚

æœ¬åœ°æ–¹æ³•è¢«æ‰§è¡Œçš„æ—¶å€™ï¼Œåœ¨æœ¬åœ°æ–¹æ³•æ ˆä¹Ÿä¼šåˆ›å»ºä¸€ä¸ªæ ˆå¸§ï¼Œç”¨äºå­˜æ”¾è¯¥æœ¬åœ°æ–¹æ³•çš„å±€éƒ¨å˜é‡è¡¨ã€æ“ä½œæ•°æ ˆã€åŠ¨æ€é“¾æ¥ã€å‡ºå£ä¿¡æ¯ã€‚

æ–¹æ³•æ‰§è¡Œå®Œæ¯•åç›¸åº”çš„æ ˆå¸§ä¹Ÿä¼šå‡ºæ ˆå¹¶é‡Šæ”¾å†…å­˜ç©ºé—´ï¼Œä¹Ÿä¼šå‡ºç° `StackOverFlowError` å’Œ `OutOfMemoryError` ä¸¤ç§é”™è¯¯ã€‚

** å †

Java è™šæ‹Ÿæœºæ‰€ç®¡ç†çš„å†…å­˜ä¸­æœ€å¤§çš„ä¸€å—ï¼ŒJava å †æ˜¯æ‰€æœ‰çº¿ç¨‹å…±äº«çš„ä¸€å—å†…å­˜åŒºåŸŸï¼Œåœ¨è™šæ‹Ÿæœºå¯åŠ¨æ—¶åˆ›å»ºã€‚**æ­¤å†…å­˜åŒºåŸŸçš„å”¯ä¸€ç›®çš„å°±æ˜¯å­˜æ”¾å¯¹è±¡å®ä¾‹ï¼Œå‡ ä¹æ‰€æœ‰çš„å¯¹è±¡å®ä¾‹ä»¥åŠæ•°ç»„éƒ½åœ¨è¿™é‡Œåˆ†é…å†…å­˜ã€‚**

Java ä¸–ç•Œä¸­â€œå‡ ä¹â€æ‰€æœ‰çš„å¯¹è±¡éƒ½åœ¨å †ä¸­åˆ†é…ï¼Œä½†æ˜¯ï¼Œéšç€ JIT ç¼–è¯‘æœŸçš„å‘å±•ä¸é€ƒé€¸åˆ†ææŠ€æœ¯é€æ¸æˆç†Ÿï¼Œæ ˆä¸Šåˆ†é…ã€æ ‡é‡æ›¿æ¢ä¼˜åŒ–æŠ€æœ¯å°†ä¼šå¯¼è‡´ä¸€äº›å¾®å¦™çš„å˜åŒ–ï¼Œæ‰€æœ‰çš„å¯¹è±¡éƒ½åˆ†é…åˆ°å †ä¸Šä¹Ÿæ¸æ¸å˜å¾—ä¸é‚£ä¹ˆâ€œç»å¯¹â€äº†ã€‚ä» JDK 1.7 å¼€å§‹å·²ç»é»˜è®¤å¼€å¯é€ƒé€¸åˆ†æï¼Œå¦‚æœæŸäº›æ–¹æ³•ä¸­çš„å¯¹è±¡å¼•ç”¨æ²¡æœ‰è¢«è¿”å›æˆ–è€…æœªè¢«å¤–é¢ä½¿ç”¨ï¼ˆä¹Ÿå°±æ˜¯æœªé€ƒé€¸å‡ºå»ï¼‰ï¼Œé‚£ä¹ˆå¯¹è±¡å¯ä»¥ç›´æ¥åœ¨æ ˆä¸Šåˆ†é…å†…å­˜ã€‚

Java å †æ˜¯åƒåœ¾æ”¶é›†å™¨ç®¡ç†çš„ä¸»è¦åŒºåŸŸï¼Œå› æ­¤ä¹Ÿè¢«ç§°ä½œ**GC å †ï¼ˆGarbage Collected Heapï¼‰**.ä»åƒåœ¾å›æ”¶çš„è§’åº¦ï¼Œç”±äºç°åœ¨æ”¶é›†å™¨åŸºæœ¬éƒ½é‡‡ç”¨åˆ†ä»£åƒåœ¾æ”¶é›†ç®—æ³•ï¼Œæ‰€ä»¥ Java å †è¿˜å¯ä»¥ç»†åˆ†ä¸ºï¼šæ–°ç”Ÿä»£å’Œè€å¹´ä»£ï¼šå†ç»†è‡´ä¸€ç‚¹æœ‰ï¼šEden ç©ºé—´ã€From Survivorã€To Survivor ç©ºé—´ç­‰ã€‚**è¿›ä¸€æ­¥åˆ’åˆ†çš„ç›®çš„æ˜¯æ›´å¥½åœ°å›æ”¶å†…å­˜ï¼Œæˆ–è€…æ›´å¿«åœ°åˆ†é…å†…å­˜ã€‚**

åœ¨ JDK 7 ç‰ˆæœ¬åŠ JDK 7 ç‰ˆæœ¬ä¹‹å‰ï¼Œå †å†…å­˜è¢«é€šå¸¸è¢«åˆ†ä¸ºä¸‹é¢ä¸‰éƒ¨åˆ†ï¼š

1. æ–°ç”Ÿä»£å†…å­˜(Young Generation)
2. è€ç”Ÿä»£(Old Generation)
3. æ°¸ç”Ÿä»£(Permanent Generation)

[[./imgs/pictures/javaå†…å­˜åŒºåŸŸ/JVMå †å†…å­˜ç»“æ„-JDK7.png]]

JDK 8 ç‰ˆæœ¬ä¹‹åæ–¹æ³•åŒºï¼ˆHotSpot çš„æ°¸ä¹…ä»£ï¼‰è¢«å½»åº•ç§»é™¤äº†ï¼ˆJDK1.7 å°±å·²ç»å¼€å§‹äº†ï¼‰ï¼Œå–è€Œä»£ä¹‹æ˜¯å…ƒç©ºé—´ï¼Œå…ƒç©ºé—´ä½¿ç”¨çš„æ˜¯ç›´æ¥å†…å­˜ã€‚

[[./imgs/pictures/javaå†…å­˜åŒºåŸŸ/JVMå †å†…å­˜ç»“æ„-jdk8.png]]

**ä¸Šå›¾æ‰€ç¤ºçš„ Eden åŒºã€ä¸¤ä¸ª Survivor åŒºéƒ½å±äºæ–°ç”Ÿä»£ï¼ˆä¸ºäº†åŒºåˆ†ï¼Œè¿™ä¸¤ä¸ª Survivor åŒºåŸŸæŒ‰ç…§é¡ºåºè¢«å‘½åä¸º from å’Œ toï¼‰ï¼Œä¸­é—´ä¸€å±‚å±äºè€å¹´ä»£ã€‚**

å¤§éƒ¨åˆ†æƒ…å†µï¼Œå¯¹è±¡éƒ½ä¼šé¦–å…ˆåœ¨ Eden åŒºåŸŸåˆ†é…ï¼Œåœ¨ä¸€æ¬¡æ–°ç”Ÿä»£åƒåœ¾å›æ”¶åï¼Œå¦‚æœå¯¹è±¡è¿˜å­˜æ´»ï¼Œåˆ™ä¼šè¿›å…¥ s0 æˆ–è€… s1ï¼Œå¹¶ä¸”å¯¹è±¡çš„å¹´é¾„è¿˜ä¼šåŠ  1(Eden åŒº->Survivor åŒºåå¯¹è±¡çš„åˆå§‹å¹´é¾„å˜ä¸º 1)ï¼Œå½“å®ƒçš„å¹´é¾„å¢åŠ åˆ°ä¸€å®šç¨‹åº¦ï¼ˆé»˜è®¤ä¸º 15 å²ï¼‰ï¼Œå°±ä¼šè¢«æ™‹å‡åˆ°è€å¹´ä»£ä¸­ã€‚å¯¹è±¡æ™‹å‡åˆ°è€å¹´ä»£çš„å¹´é¾„é˜ˆå€¼ï¼Œå¯ä»¥é€šè¿‡å‚æ•° `-XX:MaxTenuringThreshold` æ¥è®¾ç½®ã€‚

#+begin_src quote
**ğŸ› ä¿®æ­£ï¼ˆå‚è§ï¼š[issue552](https://github.com/Snailclimb/JavaGuide/issues/552)ï¼‰** ï¼šâ€œHotspot éå†æ‰€æœ‰å¯¹è±¡æ—¶ï¼ŒæŒ‰ç…§å¹´é¾„ä»å°åˆ°å¤§å¯¹å…¶æ‰€å ç”¨çš„å¤§å°è¿›è¡Œç´¯ç§¯ï¼Œå½“ç´¯ç§¯çš„æŸä¸ªå¹´é¾„å¤§å°è¶…è¿‡äº† survivor åŒºçš„ä¸€åŠæ—¶ï¼Œå–è¿™ä¸ªå¹´é¾„å’Œ MaxTenuringThreshold ä¸­æ›´å°çš„ä¸€ä¸ªå€¼ï¼Œä½œä¸ºæ–°çš„æ™‹å‡å¹´é¾„é˜ˆå€¼â€ã€‚

 **åŠ¨æ€å¹´é¾„è®¡ç®—çš„ä»£ç å¦‚ä¸‹**

 ```c++
 uint ageTable::compute_tenuring_threshold(size_t survivor_capacity) {
 	//survivor_capacityæ˜¯survivorç©ºé—´çš„å¤§å°
 size_t desired_survivor_size = (size_t)((((double) survivor_capacity)*TargetSurvivorRatio)/100);
 size_t total = 0;
 uint age = 1;
 while (age < table_size) {
 total += sizes[age];//sizesæ•°ç»„æ˜¯æ¯ä¸ªå¹´é¾„æ®µå¯¹è±¡å¤§å°
 if (total > desired_survivor_size) break;
 age++;
 }
 uint result = age < MaxTenuringThreshold ? age : MaxTenuringThreshold;
 	...
 }
#+end_src
å †è¿™é‡Œæœ€å®¹æ˜“å‡ºç°çš„å°±æ˜¯ OutOfMemoryError é”™è¯¯ï¼Œå¹¶ä¸”å‡ºç°è¿™ç§é”™è¯¯ä¹‹åçš„è¡¨ç°å½¢å¼è¿˜ä¼šæœ‰å‡ ç§ï¼Œæ¯”å¦‚ï¼š

1. **`OutOfMemoryError: GC Overhead Limit Exceeded`** ï¼š å½“ JVM èŠ±å¤ªå¤šæ—¶é—´æ‰§è¡Œåƒåœ¾å›æ”¶å¹¶ä¸”åªèƒ½å›æ”¶å¾ˆå°‘çš„å †ç©ºé—´æ—¶ï¼Œå°±ä¼šå‘ç”Ÿæ­¤é”™è¯¯ã€‚
2. **`java.lang.OutOfMemoryError: Java heap space`** :å‡å¦‚åœ¨åˆ›å»ºæ–°çš„å¯¹è±¡æ—¶, å †å†…å­˜ä¸­çš„ç©ºé—´ä¸è¶³ä»¥å­˜æ”¾æ–°åˆ›å»ºçš„å¯¹è±¡, å°±ä¼šå¼•å‘`java.lang.OutOfMemoryError: Java heap space` é”™è¯¯ã€‚(å’Œæœ¬æœºç‰©ç†å†…å­˜æ— å…³ï¼Œå’Œä½ é…ç½®çš„å†…å­˜å¤§å°æœ‰å…³ï¼)
3. ......

** æ–¹æ³•åŒº

æ–¹æ³•åŒºä¸ Java å †ä¸€æ ·ï¼Œæ˜¯å„ä¸ªçº¿ç¨‹å…±äº«çš„å†…å­˜åŒºåŸŸï¼Œå®ƒç”¨äºå­˜å‚¨å·²è¢«è™šæ‹ŸæœºåŠ è½½çš„ç±»ä¿¡æ¯ã€å¸¸é‡ã€é™æ€å˜é‡ã€å³æ—¶ç¼–è¯‘å™¨ç¼–è¯‘åçš„ä»£ç ç­‰æ•°æ®ã€‚è™½ç„¶ **Java è™šæ‹Ÿæœºè§„èŒƒæŠŠæ–¹æ³•åŒºæè¿°ä¸ºå †çš„ä¸€ä¸ªé€»è¾‘éƒ¨åˆ†**ï¼Œä½†æ˜¯å®ƒå´æœ‰ä¸€ä¸ªåˆ«åå«åš **Non-Heapï¼ˆéå †ï¼‰**ï¼Œç›®çš„åº”è¯¥æ˜¯ä¸ Java å †åŒºåˆ†å¼€æ¥ã€‚

æ–¹æ³•åŒºä¹Ÿè¢«ç§°ä¸ºæ°¸ä¹…ä»£ã€‚å¾ˆå¤šäººéƒ½ä¼šåˆ†ä¸æ¸…æ–¹æ³•åŒºå’Œæ°¸ä¹…ä»£çš„å…³ç³»ï¼Œä¸ºæ­¤æˆ‘ä¹ŸæŸ¥é˜…äº†æ–‡çŒ®ã€‚

*** æ–¹æ³•åŒºå’Œæ°¸ä¹…ä»£çš„å…³ç³»

#+begin_src quote
 ã€ŠJava è™šæ‹Ÿæœºè§„èŒƒã€‹åªæ˜¯è§„å®šäº†æœ‰æ–¹æ³•åŒºè¿™ä¹ˆä¸ªæ¦‚å¿µå’Œå®ƒçš„ä½œç”¨ï¼Œå¹¶æ²¡æœ‰è§„å®šå¦‚ä½•å»å®ç°å®ƒã€‚é‚£ä¹ˆï¼Œåœ¨ä¸åŒçš„ JVM ä¸Šæ–¹æ³•åŒºçš„å®ç°è‚¯å®šæ˜¯ä¸åŒçš„äº†ã€‚ **æ–¹æ³•åŒºå’Œæ°¸ä¹…ä»£çš„å…³ç³»å¾ˆåƒ Java ä¸­æ¥å£å’Œç±»çš„å…³ç³»ï¼Œç±»å®ç°äº†æ¥å£ï¼Œè€Œæ°¸ä¹…ä»£å°±æ˜¯ HotSpot è™šæ‹Ÿæœºå¯¹è™šæ‹Ÿæœºè§„èŒƒä¸­æ–¹æ³•åŒºçš„ä¸€ç§å®ç°æ–¹å¼ã€‚** ä¹Ÿå°±æ˜¯è¯´ï¼Œæ°¸ä¹…ä»£æ˜¯ HotSpot çš„æ¦‚å¿µï¼Œæ–¹æ³•åŒºæ˜¯ Java è™šæ‹Ÿæœºè§„èŒƒä¸­çš„å®šä¹‰ï¼Œæ˜¯ä¸€ç§è§„èŒƒï¼Œè€Œæ°¸ä¹…ä»£æ˜¯ä¸€ç§å®ç°ï¼Œä¸€ä¸ªæ˜¯æ ‡å‡†ä¸€ä¸ªæ˜¯å®ç°ï¼Œå…¶ä»–çš„è™šæ‹Ÿæœºå®ç°å¹¶æ²¡æœ‰æ°¸ä¹…ä»£è¿™ä¸€è¯´æ³•ã€‚
#+end_src

*** å¸¸ç”¨å‚æ•°

JDK 1.8 ä¹‹å‰æ°¸ä¹…ä»£è¿˜æ²¡è¢«å½»åº•ç§»é™¤çš„æ—¶å€™é€šå¸¸é€šè¿‡ä¸‹é¢è¿™äº›å‚æ•°æ¥è°ƒèŠ‚æ–¹æ³•åŒºå¤§å°

#+begin_src java
-XX:PermSize=N //æ–¹æ³•åŒº (æ°¸ä¹…ä»£) åˆå§‹å¤§å°
-XX:MaxPermSize=N //æ–¹æ³•åŒº (æ°¸ä¹…ä»£) æœ€å¤§å¤§å°,è¶…è¿‡è¿™ä¸ªå€¼å°†ä¼šæŠ›å‡º OutOfMemoryError å¼‚å¸¸:java.lang.OutOfMemoryError: PermGen
#+end_src
ç›¸å¯¹è€Œè¨€ï¼Œåƒåœ¾æ”¶é›†è¡Œä¸ºåœ¨è¿™ä¸ªåŒºåŸŸæ˜¯æ¯”è¾ƒå°‘å‡ºç°çš„ï¼Œä½†å¹¶éæ•°æ®è¿›å…¥æ–¹æ³•åŒºåå°±â€œæ°¸ä¹…å­˜åœ¨â€äº†ã€‚

JDK 1.8 çš„æ—¶å€™ï¼Œæ–¹æ³•åŒºï¼ˆHotSpot çš„æ°¸ä¹…ä»£ï¼‰è¢«å½»åº•ç§»é™¤äº†ï¼ˆJDK1.7 å°±å·²ç»å¼€å§‹äº†ï¼‰ï¼Œå–è€Œä»£ä¹‹æ˜¯å…ƒç©ºé—´ï¼Œå…ƒç©ºé—´ä½¿ç”¨çš„æ˜¯ç›´æ¥å†…å­˜ã€‚

ä¸‹é¢æ˜¯ä¸€äº›å¸¸ç”¨å‚æ•°ï¼š

#+begin_src java
-XX:MetaspaceSize=N //è®¾ç½® Metaspace çš„åˆå§‹ï¼ˆå’Œæœ€å°å¤§å°ï¼‰
-XX:MaxMetaspaceSize=N //è®¾ç½® Metaspace çš„æœ€å¤§å¤§å°
#+end_src

ä¸æ°¸ä¹…ä»£å¾ˆå¤§çš„ä¸åŒå°±æ˜¯ï¼Œå¦‚æœä¸æŒ‡å®šå¤§å°çš„è¯ï¼Œéšç€æ›´å¤šç±»çš„åˆ›å»ºï¼Œè™šæ‹Ÿæœºä¼šè€—å°½æ‰€æœ‰å¯ç”¨çš„ç³»ç»Ÿå†…å­˜ã€‚

*** ä¸ºä»€ä¹ˆè¦å°†æ°¸ä¹…ä»£ (PermGen) æ›¿æ¢ä¸ºå…ƒç©ºé—´ (MetaSpace) å‘¢?

ä¸‹å›¾æ¥è‡ªã€Šæ·±å…¥ç†è§£ Java è™šæ‹Ÿæœºã€‹ç¬¬ 3 ç‰ˆ 2.2.5

[[https://img-blog.csdnimg.cn/20210425134508117.png]]

1. æ•´ä¸ªæ°¸ä¹…ä»£æœ‰ä¸€ä¸ª JVM æœ¬èº«è®¾ç½®çš„å›ºå®šå¤§å°ä¸Šé™ï¼Œæ— æ³•è¿›è¡Œè°ƒæ•´ï¼Œè€Œå…ƒç©ºé—´ä½¿ç”¨çš„æ˜¯ç›´æ¥å†…å­˜ï¼Œå—æœ¬æœºå¯ç”¨å†…å­˜çš„é™åˆ¶ï¼Œè™½ç„¶å…ƒç©ºé—´ä»æ—§å¯èƒ½æº¢å‡ºï¼Œä½†æ˜¯æ¯”åŸæ¥å‡ºç°çš„å‡ ç‡ä¼šæ›´å°ã€‚

#+begin_src quote
    å½“å…ƒç©ºé—´æº¢å‡ºæ—¶ä¼šå¾—åˆ°å¦‚ä¸‹é”™è¯¯ï¼š `java.lang.OutOfMemoryError: MetaSpace`
#+end_src

ä½ å¯ä»¥ä½¿ç”¨ `-XXï¼šMaxMetaspaceSize` æ ‡å¿—è®¾ç½®æœ€å¤§å…ƒç©ºé—´å¤§å°ï¼Œé»˜è®¤å€¼ä¸º unlimitedï¼Œè¿™æ„å‘³ç€å®ƒåªå—ç³»ç»Ÿå†…å­˜çš„é™åˆ¶ã€‚`-XXï¼šMetaspaceSize` è°ƒæ•´æ ‡å¿—å®šä¹‰å…ƒç©ºé—´çš„åˆå§‹å¤§å°å¦‚æœæœªæŒ‡å®šæ­¤æ ‡å¿—ï¼Œåˆ™ Metaspace å°†æ ¹æ®è¿è¡Œæ—¶çš„åº”ç”¨ç¨‹åºéœ€æ±‚åŠ¨æ€åœ°é‡æ–°è°ƒæ•´å¤§å°ã€‚

2. å…ƒç©ºé—´é‡Œé¢å­˜æ”¾çš„æ˜¯ç±»çš„å…ƒæ•°æ®ï¼Œè¿™æ ·åŠ è½½å¤šå°‘ç±»çš„å…ƒæ•°æ®å°±ä¸ç”± `MaxPermSize` æ§åˆ¶äº†, è€Œç”±ç³»ç»Ÿçš„å®é™…å¯ç”¨ç©ºé—´æ¥æ§åˆ¶ï¼Œè¿™æ ·èƒ½åŠ è½½çš„ç±»å°±æ›´å¤šäº†ã€‚

3. åœ¨ JDK8ï¼Œåˆå¹¶ HotSpot å’Œ JRockit çš„ä»£ç æ—¶, JRockit ä»æ¥æ²¡æœ‰ä¸€ä¸ªå«æ°¸ä¹…ä»£çš„ä¸œè¥¿, åˆå¹¶ä¹‹åå°±æ²¡æœ‰å¿…è¦é¢å¤–çš„è®¾ç½®è¿™ä¹ˆä¸€ä¸ªæ°¸ä¹…ä»£çš„åœ°æ–¹äº†ã€‚

** è¿è¡Œæ—¶å¸¸é‡æ± 

è¿è¡Œæ—¶å¸¸é‡æ± æ˜¯æ–¹æ³•åŒºçš„ä¸€éƒ¨åˆ†ã€‚Class æ–‡ä»¶ä¸­é™¤äº†æœ‰ç±»çš„ç‰ˆæœ¬ã€å­—æ®µã€æ–¹æ³•ã€æ¥å£ç­‰æè¿°ä¿¡æ¯å¤–ï¼Œè¿˜æœ‰å¸¸é‡æ± è¡¨ï¼ˆç”¨äºå­˜æ”¾ç¼–è¯‘æœŸç”Ÿæˆçš„å„ç§å­—é¢é‡å’Œç¬¦å·å¼•ç”¨ï¼‰

æ—¢ç„¶è¿è¡Œæ—¶å¸¸é‡æ± æ˜¯æ–¹æ³•åŒºçš„ä¸€éƒ¨åˆ†ï¼Œè‡ªç„¶å—åˆ°æ–¹æ³•åŒºå†…å­˜çš„é™åˆ¶ï¼Œå½“å¸¸é‡æ± æ— æ³•å†ç”³è¯·åˆ°å†…å­˜æ—¶ä¼šæŠ›å‡º OutOfMemoryError é”™è¯¯ã€‚

~~**JDK1.7 åŠä¹‹åç‰ˆæœ¬çš„ JVM å·²ç»å°†è¿è¡Œæ—¶å¸¸é‡æ± ä»æ–¹æ³•åŒºä¸­ç§»äº†å‡ºæ¥ï¼Œåœ¨ Java å †ï¼ˆHeapï¼‰ä¸­å¼€è¾Ÿäº†ä¸€å—åŒºåŸŸå­˜æ”¾è¿è¡Œæ—¶å¸¸é‡æ± ã€‚**~~

#+begin_src quote
**ğŸ› ä¿®æ­£ï¼ˆå‚è§ï¼š[issue747](https://github.com/Snailclimb/JavaGuide/issues/747)ï¼Œ[reference](https://blog.csdn.net/q5706503/article/details/84640762)ï¼‰** ï¼š

 1. **JDK1.7 ä¹‹å‰è¿è¡Œæ—¶å¸¸é‡æ± é€»è¾‘åŒ…å«å­—ç¬¦ä¸²å¸¸é‡æ± å­˜æ”¾åœ¨æ–¹æ³•åŒº, æ­¤æ—¶ hotspot è™šæ‹Ÿæœºå¯¹æ–¹æ³•åŒºçš„å®ç°ä¸ºæ°¸ä¹…ä»£**
 2. **JDK1.7 å­—ç¬¦ä¸²å¸¸é‡æ± è¢«ä»æ–¹æ³•åŒºæ‹¿åˆ°äº†å †ä¸­, è¿™é‡Œæ²¡æœ‰æåˆ°è¿è¡Œæ—¶å¸¸é‡æ± ,ä¹Ÿå°±æ˜¯è¯´å­—ç¬¦ä¸²å¸¸é‡æ± è¢«å•ç‹¬æ‹¿åˆ°å †,è¿è¡Œæ—¶å¸¸é‡æ± å‰©ä¸‹çš„ä¸œè¥¿è¿˜åœ¨æ–¹æ³•åŒº, ä¹Ÿå°±æ˜¯ hotspot ä¸­çš„æ°¸ä¹…ä»£** ã€‚
 3. **JDK1.8 hotspot ç§»é™¤äº†æ°¸ä¹…ä»£ç”¨å…ƒç©ºé—´(Metaspace)å–è€Œä»£ä¹‹, è¿™æ—¶å€™å­—ç¬¦ä¸²å¸¸é‡æ± è¿˜åœ¨å †, è¿è¡Œæ—¶å¸¸é‡æ± è¿˜åœ¨æ–¹æ³•åŒº, åªä¸è¿‡æ–¹æ³•åŒºçš„å®ç°ä»æ°¸ä¹…ä»£å˜æˆäº†å…ƒç©ºé—´(Metaspace)**

#+end_src

ç›¸å…³é—®é¢˜ï¼šJVM å¸¸é‡æ± ä¸­å­˜å‚¨çš„æ˜¯å¯¹è±¡è¿˜æ˜¯å¼•ç”¨å‘¢ï¼Ÿï¼š https://www.zhihu.com/question/57109429/answer/151717241 by RednaxelaFX

** ç›´æ¥å†…å­˜

**ç›´æ¥å†…å­˜å¹¶ä¸æ˜¯è™šæ‹Ÿæœºè¿è¡Œæ—¶æ•°æ®åŒºçš„ä¸€éƒ¨åˆ†ï¼Œä¹Ÿä¸æ˜¯è™šæ‹Ÿæœºè§„èŒƒä¸­å®šä¹‰çš„å†…å­˜åŒºåŸŸï¼Œä½†æ˜¯è¿™éƒ¨åˆ†å†…å­˜ä¹Ÿè¢«é¢‘ç¹åœ°ä½¿ç”¨ã€‚è€Œä¸”ä¹Ÿå¯èƒ½å¯¼è‡´ OutOfMemoryError é”™è¯¯å‡ºç°ã€‚**

JDK1.4 ä¸­æ–°åŠ å…¥çš„ **NIO(New Input/Output) ç±»**ï¼Œå¼•å…¥äº†ä¸€ç§åŸºäº**é€šé“ï¼ˆChannelï¼‰** ä¸**ç¼“å­˜åŒºï¼ˆBufferï¼‰** çš„ I/O æ–¹å¼ï¼Œå®ƒå¯ä»¥ç›´æ¥ä½¿ç”¨ Native å‡½æ•°åº“ç›´æ¥åˆ†é…å †å¤–å†…å­˜ï¼Œç„¶åé€šè¿‡ä¸€ä¸ªå­˜å‚¨åœ¨ Java å †ä¸­çš„ DirectByteBuffer å¯¹è±¡ä½œä¸ºè¿™å—å†…å­˜çš„å¼•ç”¨è¿›è¡Œæ“ä½œã€‚è¿™æ ·å°±èƒ½åœ¨ä¸€äº›åœºæ™¯ä¸­æ˜¾è‘—æé«˜æ€§èƒ½ï¼Œå› ä¸º**é¿å…äº†åœ¨ Java å †å’Œ Native å †ä¹‹é—´æ¥å›å¤åˆ¶æ•°æ®**ã€‚

æœ¬æœºç›´æ¥å†…å­˜çš„åˆ†é…ä¸ä¼šå—åˆ° Java å †çš„é™åˆ¶ï¼Œä½†æ˜¯ï¼Œæ—¢ç„¶æ˜¯å†…å­˜å°±ä¼šå—åˆ°æœ¬æœºæ€»å†…å­˜å¤§å°ä»¥åŠå¤„ç†å™¨å¯»å€ç©ºé—´çš„é™åˆ¶ã€‚
